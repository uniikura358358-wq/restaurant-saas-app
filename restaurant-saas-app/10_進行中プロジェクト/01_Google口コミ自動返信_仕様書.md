# Google口コミ自動返信ツール — 機能仕様書

作成日: 2026-02-13
最終更新: 2026-02-13 19:30
ステータス: 開発中

---

## 1. 実装済み機能

| 機能                             | 技術スタック                                    | 状態         |
| -------------------------------- | ----------------------------------------------- | ------------ |
| Supabase Auth (PKCE)             | `@supabase/ssr` + `exchangeCodeForSession`      | ✅ 実装済み |
| トースト通知                     | `sonner` (top-center, richColors)               | ✅ 実装済み |
| ログイン後の1秒待機リダイレクト   | フロント側で通知表示後に遷移                    | ✅ 実装済み |
| セキュアな auth/callback ルート   | オープンリダイレクト防御・期限切れ判定           | ✅ 実装済み |
| トーン設定画面                   | `settings/tone-config/page.tsx`                 | ✅ 実装済み |
| 星別自動/手動トグル               | Switch + reply_config (jsonb)                   | ✅ 実装済み |
| 絵文字量設定                     | Slider (0〜3の4段階)                            | ✅ 実装済み |
| 評価別判定ロジック               | `src/lib/review-handler.ts`                     | ✅ 実装済み |
| 絵文字強制除去（安全弁）          | 星2以下は正規表現で絵文字を除去                 | ✅ 実装済み |
| AI出力ノイズ除去                 | 不要フレーズの正規表現除去 + 文字数制限          | ✅ 実装済み |
| キャッシュ判定                   | 同一口コミの再生成防止 (TTL: 24時間)            | ✅ 実装済み |
| 設定変更時のキャッシュパージ      | `revalidatePath` による即時反映                 | ✅ 実装済み |

---

## 2. 未実装機能

| 機能                              | 概要                             | 優先度 |
| --------------------------------- | -------------------------------- | ------ |
| Google Business Profile API 連携  | 口コミの自動取得・返信投稿       | 高     |
| Gemini プロンプトエンジン          | AI返信文の自動生成               | 高     |
| プラン制限 (Feature Gating)       | 契約プランに基づくUI/機能制限    | 中     |

---

## 3. 返信定型文マスター

### 【極・感謝】

- **用途**: 星5・絶賛レビュー用
- **トーン**: 最大限の感謝と喜びを表現

### 【誠実・改善】

- **用途**: 星1〜2・苦情レビュー用
- **トーン**: 真摯な謝罪と具体的な改善策の提示
- **制約**: 絵文字禁止（プログラム側で強制除去）

### 【親愛・再会】

- **用途**: 常連のお客様用
- **トーン**: 親しみと再来店への期待

### 【標準・丁寧】

- **用途**: 星3以上・コメントなしレビュー用
- **トーン**: 丁寧かつ簡潔な感謝

---

## 4. 評価別ルーティング

| 星数 | デフォルト | 通知メッセージ                  | 絵文字     |
| ---- | ---------- | ------------------------------- | ---------- |
| 星1  | 手動       | 「星1つの投稿がありました」     | 禁止       |
| 星2  | 手動       | 「星2つの投稿がありました」     | 禁止       |
| 星3  | 自動       | 「星3つの投稿がありました」     | トーン依存 |
| 星4  | 自動       | 「星4つの投稿がありました」     | トーン依存 |
| 星5  | 自動       | 「星5つの投稿がありました」     | トーン依存 |

※ 各星数の自動/手動はトーン設定画面から個別に変更可能

---

## 5. セキュリティ対策

1. **RLS検証**: 全クエリで `auth.uid() = user_id` を確認
2. **絵文字安全弁**: `if (rating <= 2)` で正規表現による強制除去
3. **キャッシュパージ**: 設定変更時に `revalidatePath` で即時反映
4. **AIコスト削減**: 口コミ内容に変化がない場合、既存キャッシュを優先（TTL: 24時間）
5. **AI出力制約**: プロンプトに「返信文以外の出力禁止」制約 + 出力文字数チェック

---

## 6. データベーステーブル拡張（要実行SQL）

```sql
ALTER TABLE store_settings
  ADD COLUMN IF NOT EXISTS emoji_level integer DEFAULT 2 CHECK (emoji_level BETWEEN 0 AND 3),
  ADD COLUMN IF NOT EXISTS reply_config jsonb DEFAULT '{
    "1": "manual", "2": "manual", "3": "auto", "4": "auto", "5": "auto"
  }'::jsonb;
```

---

## 7. 技術スタック

- **フレームワーク**: Next.js 16.1.6 (App Router)
- **UI**: React 19.2.3, Shadcn UI (new-york), Tailwind CSS v4
- **認証**: Supabase Auth (PKCE Flow)
- **データベース**: Supabase (PostgreSQL + RLS)
- **AI**: Google Gemini (`@google/generative-ai`)
- **通知**: sonner
- **型安全性**: TypeScript (`any` 使用禁止)
