# AI 開発・エンジニアリング命令規則 (Professional & Business Logic)

## 1. 基本方針 (Core Philosophy)
* **言語統一 & 形式準拠**: 
    * タスク進行表、仕様書、作業完了レポート、進捗報告、コードコメントはすべて「日本語」で記述すること。
    * 出力は UTF-8 形式を厳守し、文字化けや絵文字ノイズを完全に排除すること。
* **仕様書優先**: 作業開始前に必ず `10_進行中プロジェクト` 配下の最新仕様書を確認し、文脈を同期すること。
* **論理的整合性**: 常に論理的整合性の高い情報を抽出し、ストローマン論法を排除すること。
* **冷徹な事実主義**: 証拠（ログ/URL等）があるもののみを「事実」とし、証拠がない場合は「不明」と明記すること。
* **最新性の追求**: 最新情報を取得・分析し、指定ツールより有効な新しいAIサービスがある場合は積極的に提案すること。

## 2. 技術スタック・性能管理 (Technical & Performance)
* **Next.js 15/16 (App Router)**:
    * `cookies()` や `headers()` などの非同期APIは必ず `await` 処理を行うこと。
    * Server Components をデフォルトとし、Client Components は最小化してサイトの軽量化を図ること。
* **パフォーマンス最適化**:
    * `next/image` を強制し画像最適化を徹底すること。
    * 不要なライブラリ導入を避け、DRY原則を遵守してコードの肥大化を防ぐこと。
* **厳格な型定義**: TypeScript の `any` 使用を厳禁とし、Type Safety を担保すること。

## 3. セキュリティ・環境管理 (Security & Environment)
* **認証フロー**: Supabase (PKCE Flow) を使用し、`exchangeCodeForSession` で安全に処理すること。
* **データ保護**: 全てのDB操作において、Supabaseの RLS ポートフォリオが `auth.uid() = user_id` であることを確認すること。
* **APIキー/パス管理**: 
    * 秘密情報は必ず `.env.local` で管理し、絶対にコード内にハードコーディングしないこと。
    * パス管理は環境変数を動的に使用し、ローカルと本番（eos-gp.com）の切り替えを安全に行うこと。
* **HTTPS/クリップボード**: クリップボード操作の実装時は、HTTPS環境下での動作を前提としたフォールバック設計を行うこと。

## 4. ビジネスルール (Specific Business Rules)
* **プラン制限 (Feature Gating)**: 
    * 契約プラン（単品、セット、年払い等）に基づいた UI/機能制限を徹底すること。
    * 権限のない機能へのアクセスはサーバーサイド（Middleware/Actions）で遮断すること。
* **SMSクォータ管理**:
    * SMS送信処理の直前には、必ず `store_usage` テーブルを参照し、月間上限（標準10回/上位20回）を超えていないかバリデーションを行うこと。
    * 送信成功時には、`sms_sent_count` をインクリメントする処理をアトミックに実行すること。
    * 上限値は `store_settings.sms_limit_override` で管理し、プラン変更時は即座に反映すること。

## 5. プロジェクト構造 (Directory Structure)
Obsidian 管理ルールに基づき、以下のフォルダ構成を厳守すること：
* 00_経営・戦略 (📄 Dashboard.md)
* 10_進行中プロジェクト (仕様書、タスク)
* 80_システム・管理
* 90_ログ・日報 (活動記録)
* 97_タグ一覧表
* 98_アーカイブ
* 99_テンプレート

## 6. 運用・出力ルール
* **画像生成指示を受け取った場合、1回の実行につき最大4枚の画像を生成します。生成された画像は必ずローカルの/public/images/ディレクトリに物理的に保存してください。
* **保存後、ファイルパスが表示されたらタスク完了とみなしてください。
* **許可制**: コード作成、画像生成の実行前には必ずユーザーの許可を得ること。
* **UI表示**: トースト通知は `sonner` を使用し、位置は画面上部中央 (top-center)、`richColors` を有効にすること。
* **リダイレクト**: Server Actions 内で直接 `redirect` せず、フロント側で通知表示後に遷移を実行すること。
* **リスク管理**: 全ての回答の末尾には、必ず「反証5つの対策方法」を提示すること。