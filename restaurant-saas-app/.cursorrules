# 🛡️ AI 開発・エンジニアリング命令規則

# Firebase統一方針・重大変更のみ許可制・最終確定版

────────────────────────────────

## ■ 絶対原則（最優先）

### ■ 日本語報告原則（絶対遵守・最上位）

すべてのユーザー向け出力は日本語（UTF-8）で作成すること。

#### ■ 日本語で必ず作成する対象（英語禁止）

- タスクファイル更新（Task_Tracker.md）
- 【PLAN】実施計画書
- 【PROGRESS】途中経過報告
- 【DONE】作業報告書
- 仕様・設計説明
- エラー説明・ログ説明
- 技術判断の報告
- タスクが完了したらDashboard.mdの更新と90_ログ・日報の記録を必ずつける
- **開発ノウハウ自動同期（重要）**: コード修正・追加時は必ず `../20_開発ノウハウ/` 内の関連マスター仕様書を読み込み、差分を自動更新すること。
- **価格改定時の同期（絶対遵守）**: プラン価格や決済金額に変更があった場合は、必ず `../00_経営・戦略/PRICING_PLANS.md` および `00_経営・戦略/PRICING_PLANS.md` を最新状態に更新すること。
- **ダッシュボードの同期（絶対遵守）**: タスク完了時に `00_経営・戦略/Dashboard.md` を更新した際は、必ず `../00_経営・戦略/Dashboard.md` にも同期して最新の開発状況を可視化すること。

#### ■ 英語ログの扱い

- 外部AI・ビルドツール・SDKが英語ログを出力すること自体は禁止しない。
- ただし、ユーザーへ提示する場合は必ず日本語要約を添えること。
- 英語原文のみを貼り付けることは禁止。

#### ■ 表記ルール

- UTF-8で記述すること
- コードコメントは日本語
- 文字化け禁止
- 過度な絵文字使用禁止
開発・運用ルール (Protocol)

#### ■タスク完了後は必ず以下を実行すること：**

1. `90_ログ・日報/Task_Tracker.md` の更新
2. `90_ログ・日報/YYYY-MM-DD_日報.md` への記録（変更内容・ファイル名）
3. 計画表 (`Dashboard.md`) の更新（進捗があれば）
────────────────────────────────

### ■ 単一の正（Single Source of Truth）

- 認証の正：Firebase Auth
- データベースの正：Cloud Firestore
- サーバー権限：Firebase Admin SDK（サーバー専用）
- 課金の正：Stripe（Webhook → Firestore更新）
- 仕様の正：10_進行中プロジェクト / 00_経営・戦略/PRICING_PLANS.md (販売ページ page.tsx と完全同期済み)
- タスク管理の正：90_ログ・日報/Task_Tracker.md

Supabaseによる認証・保存は禁止。
併用禁止（将来的な分析用途のみ例外）。

────────────────────────────────

## ■ 開発プロセス（ブラックボックス禁止）

### 【PLAN】（重大変更のみ必須）

以下に該当する場合は必ず事前提出：

- 認証・認可変更
- Firestore構造変更
- 課金・プラン変更
- 破壊的変更
- 本番データ影響の可能性

提示内容：

- 修正対象ファイル
- 依存関係
- 影響範囲（UI/API/DB/認証/課金/権限）
- ロールバック手順
- 想定リスク最大3つ

────────────────────────────────

### 【PROGRESS】

3ファイル以上の変更時のみ表示：

[PROGRESS 2/5]

軽微変更では不要。

────────────────────────────────

### 【DONE】（常時必須）

- 実施内容
- 動作確認（ログイン / 主要機能 / 例外系）
- DB整合性確認
- 未完了タスク
- 反証（軽微変更＝3つ、重大変更＝5つ）

────────────────────────────────

## ■ 重大変更時の日報ログ義務（必須）

重大変更が発生した場合、必ず以下を  
90_ログ・日報 に記録すること。

記録内容：

- 実施日時
- 変更概要
- 変更理由（なぜ必要だったか）
- 影響範囲（UI / API / DB / 認証 / 課金 / 権限）
- ロールバック方法
- 残課題（あれば）
- 反証5つと対策

記録は日本語（UTF-8）で作成すること。

────────────────────────────────

## ■ Firestore設計原則

### 1. 書き込みは必ずサーバー経由

- Admin SDKはサーバー限定
- クライアントから直接Firestore更新は禁止

### 2. トランザクション必須箇所

- 返信保存＋未返信数更新
- クォータ減算
- プラン変更
- Stripe Webhook

### 3. 冪等性（Idempotency）

- requestId必須
- 同一requestIdで再実行しても状態不変

### 4. サマリドキュメント

tenants/{tenantId}/stats/current

保持項目：

- totalReviews
- unrepliedCount
- avgRating
- lowRatingCount
- updatedAt

全件集計禁止。

### 5. ページング

- 初期取得20件
- orderBy(createdAt desc) + id
- startAfter方式

────────────────────────────────

## ■ セキュリティ原則

禁止事項：

- service accountのクライアント露出
- Admin SDKのクライアント使用
- 環境変数ハードコード
- Webhook署名未検証
- PIIログ出力

秘密情報は .env.local のみで管理。

────────────────────────────────

## ■ Feature Gating（契約制御）

- UIのみで制限することは禁止
- Server Actionで必ず遮断
- Firestoreのsubscription.status確認必須
- クォータはアトミックに検証

────────────────────────────────

## ■ 技術スタック規則

- Next.js 15/16（App Router）
- Server Components優先
- Client最小化
- 非同期APIは必ずawait
- any型禁止
- next/image使用
- DRY原則遵守
- 不要なライブラリ導入禁止

────────────────────────────────

## ■ Stripe運用規則

- Webhook署名検証必須
- subscription更新はtransactionで実施
- 支払い失敗時は制限状態へ変更

────────────────────────────────

## ■ タスク管理

- Task_Tracker.mdを維持管理
- 重大変更時は必ず更新
- 軽微変更はセッション単位でまとめて更新可

────────────────────────────────

## ■ 実行許可制

### 承認不要（自走可）

- UI微修正
- 型安全化
- リファクタ（挙動不変）
- ログ整理
- ドキュメント修正

### 承認必須

- 認証変更
- DB構造変更
- 課金変更
- 権限変更
- 本番影響の可能性

## ■ AIモデル運用規則（最優先・恒久固定・以後変更禁止）

1. **メイン：`gemini-3-flash-preview`**
   - 思考レベル（Thinking Level）：**`LOW`**
   - 用途：全てのAI返信、テキスト生成、POP生成、画像解析、その他全てのAI機能
2. **サブ（フォールバック）：`gemini-2.5-flash`**
   - 用途：メインのタイムアウト、エラー時の予備

原則としてメインを使用し、タイムアウトやエラー時のみサブへ切り替えること。この構成はコストとパフォーマンスの最適解として固定し、ユーザーの明示的な許可なく変更を禁止する。

────────────────────────────────

## ■ 開発姿勢

- 証拠があるもののみ事実とする
- 不明な点は「不明」と明記
- 推測で実装しない
- 仕様書を最優先とする
- 日本で利用可能な最新API規格と仕様を調査して随時更新
- 日本で利用可能な最新AI技術を調査する
- 画像生成の指示を受けた際は、1回の実行につき最大4枚まで生成すること。
- 生成した画像をメモリ内に保持（キャッシュ）せず、必ずローカルの /public/images/
- ディレクトリに物理ファイルとして保存すること。 保存完了後、ユーザーに対してその
- ファイルパスを提示した時点でタスク完了とみなす。
──────────────────────────────

## ■ 目的

- Errorを出さない構造を作る
- ブラックボックスを排除する
- 保守コストを最小化する
- 単一の正を守る
- 日本語報告を徹底する

────────────────────────────────

## ■ 反証（本規則へのリスクと対策）

1. 規則が厳格すぎて開発速度が低下する可能性  
→ 重大変更のみPLAN必須とし、軽微変更は自走可

2. Firestore従量課金が増加する可能性  
→ stats＋ページング＋最小取得設計を徹底

3. 承認不要範囲が拡大解釈される可能性  
→ 認証/DB/課金/権限は常に承認必須固定

4. 英語ログ要約漏れの可能性  
→ 英語提示時は必ず日本語要約を義務化

5. 将来スケール時の技術的限界  
→ 分析用途は将来ETL追加（正はFirestore維持）