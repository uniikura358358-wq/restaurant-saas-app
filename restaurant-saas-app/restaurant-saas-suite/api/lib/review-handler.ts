/**
 * ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
 * 
 * æ©Ÿèƒ½:
 * - æ˜Ÿæ•°ã«å¿œã˜ãŸè‡ªå‹•é€ä¿¡/ä¸‹æ›¸ãä¿å­˜ã®åˆ¤å®š
 * - æ˜Ÿ2ä»¥ä¸‹ã®ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«é€šçŸ¥æ–‡ç”Ÿæˆ
 * - ä½è©•ä¾¡æ™‚ã®çµµæ–‡å­—å¼·åˆ¶é™¤å»ï¼ˆå®‰å…¨å¼ï¼‰
 * - AIå‡ºåŠ›ã®ãƒã‚¤ã‚ºé™¤å»
 * - ç”Ÿæˆã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¤å®š
 */

// --- å‹å®šç¾© ---

/** è¿”ä¿¡ãƒ¢ãƒ¼ãƒ‰: è‡ªå‹•é€ä¿¡ or æ‰‹å‹•ï¼ˆä¸‹æ›¸ãä¿å­˜ï¼‰ */
type ReplyMode = "auto" | "manual";

/** æ˜Ÿ1ã€œ5ã«å¯¾ã™ã‚‹è¿”ä¿¡è¨­å®šãƒãƒƒãƒ— */
interface ReplyConfig {
    "1": ReplyMode;
    "2": ReplyMode;
    "3": ReplyMode;
    "4": ReplyMode;
    "5": ReplyMode;
}

/** é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡ºåŠ› */
interface NotificationResult {
    /** é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ */
    message: string;
    /** é€šçŸ¥ã®ç¨®åˆ¥ï¼ˆäº‹å®Ÿãƒ™ãƒ¼ã‚¹ã‹ã€ãƒˆãƒ¼ãƒ³ä»˜ãã‹ï¼‰ */
    type: "neutral" | "toned";
}

/** ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ¤å®šçµæœ */
interface ReviewActionResult {
    /** è‡ªå‹•é€ä¿¡ã‹æ‰‹å‹•ã‹ */
    mode: ReplyMode;
    /** é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    notification: NotificationResult;
}

/** ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¤å®šç”¨ã®æ—¢å­˜è¿”ä¿¡ãƒ‡ãƒ¼ã‚¿ */
interface CachedReply {
    /** å…ƒã®å£ã‚³ãƒŸãƒ†ã‚­ã‚¹ãƒˆ */
    originalReviewText: string;
    /** ç”Ÿæˆæ¸ˆã¿è¿”ä¿¡æ–‡ */
    generatedReply: string;
    /** ç”Ÿæˆæ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆISOæ–‡å­—åˆ—ï¼‰ */
    generatedAt: string;
}

/** ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé–“ï¼ˆ24æ™‚é–“ = 86400000ãƒŸãƒªç§’ï¼‰ */
const CACHE_TTL_MS = 24 * 60 * 60 * 1000;

// --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š ---

/** ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¿”ä¿¡è¨­å®šï¼ˆæ˜Ÿ3ä»¥ä¸ŠãŒè‡ªå‹•ã€æ˜Ÿ1ã€œ2ãŒæ‰‹å‹•ï¼‰ */
const DEFAULT_REPLY_CONFIG: ReplyConfig = {
    "1": "manual",
    "2": "manual",
    "3": "auto",
    "4": "auto",
    "5": "auto",
};

// --- çµµæ–‡å­—é™¤å»ã®å®‰å…¨å¼ ---

/**
 * Unicodeçµµæ–‡å­—ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡ºãƒ»é™¤å»ã™ã‚‹
 * å¯¾è±¡: ä¸€èˆ¬çš„ãªçµµæ–‡å­—ç¯„å›²ï¼ˆEmoji_Presentation + Emoji_Modifierç­‰ï¼‰
 */
/**
 * Unicodeçµµæ–‡å­—ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡ºãƒ»é™¤å»ã™ã‚‹
 * å¯¾è±¡: ä¸€èˆ¬çš„ãªçµµæ–‡å­—ç¯„å›² + ZWJã‚·ãƒ¼ã‚±ãƒ³ã‚¹
 */
const EMOJI_REGEX = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)(\u200D(\p{Emoji_Presentation}|\p{Emoji}\uFE0F))*/gu;

/**
 * æ˜Ÿ2ä»¥ä¸‹ã®è¿”ä¿¡æ–‡ã‹ã‚‰çµµæ–‡å­—ã‚’åˆ¶é™ã™ã‚‹
 * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: ä½è©•ä¾¡ã¸ã®è¿”ä¿¡ã«çµµæ–‡å­—ã¯ä¸é©åˆ‡ï¼ˆã¾ãŸã¯æœ€å°é™ã«ç•™ã‚ã‚‹ã¹ãï¼‰
 * 
 * @param text - AIç”Ÿæˆã®è¿”ä¿¡æ–‡
 * @param rating - å£ã‚³ãƒŸã®æ˜Ÿæ•°ï¼ˆ1ã€œ5ï¼‰
 * @returns çµµæ–‡å­—åˆ¶é™å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ
 */
export function sanitizeEmoji(text: string, rating: number): string {
    if (rating <= 2) {
        // çµµæ–‡å­—ï¼ˆZWJã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å«ã‚€ï¼‰ã‚’æŠ½å‡º
        // ğŸ™‡â€â™‚ï¸ ãªã©ã®è¤‡é›‘ãªçµµæ–‡å­—ã‚’ä¸€ã¤ã®å¡Šã¨ã—ã¦ãƒãƒƒãƒã•ã›ã‚‹
        const emojiMatches = text.match(EMOJI_REGEX) || [];

        if (emojiMatches.length > 2) {
            // 3å€‹ç›®ä»¥é™ã®çµµæ–‡å­—ã‚’ç½®æ›å¯¾è±¡ã«ã™ã‚‹
            // è¤‡é›‘ãªçµµæ–‡å­—ãŒé€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã€å‡ºç¾å›æ•°ãƒ™ãƒ¼ã‚¹ã§åˆ¶å¾¡ã™ã‚‹ãƒ«ãƒ¼ã‚¿ãƒ¼å‹ç½®æ›
            let count = 0;
            return text.replace(EMOJI_REGEX, (match) => {
                count++;
                return count <= 2 ? match : "";
            }).replace(/\s{2,}/g, " ").trim();
        }
    }
    return text;
}

// --- AIå‡ºåŠ›ãƒã‚¤ã‚ºé™¤å» ---

/** AI ãŒä»˜åŠ ã—ãŒã¡ãªä¸è¦ãƒ•ãƒ¬ãƒ¼ã‚ºä¸€è¦§ */
const NOISE_PATTERNS: RegExp[] = [
    /AIã§ä½œæˆã—ã¾ã—ãŸ/g,
    /AI ãŒç”Ÿæˆã—ã¾ã—ãŸ/g,
    /ã“ã®è¿”ä¿¡ã¯è‡ªå‹•ç”Ÿæˆã§ã™/g,
    /Generated by AI/gi,
    /This reply was generated/gi,
    /ä»¥ä¸ŠãŒè¿”ä¿¡ã§ã™[ã€‚.]?/g,
    /ä»¥ä¸‹ãŒè¿”ä¿¡æ–‡ã§ã™[ã€‚:]?/g,
    /è¿”ä¿¡æ–‡[:ï¼š]/g,
    /```[\s\S]*?```/g, // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®é™¤å»
    /ã€æ„Ÿè¬ã€‘/g,
    /ã€å…±æ„Ÿãƒ»è¬ç½ªã€‘/g,
    /ã€å€‹åˆ¥å¯¾å¿œã€‘/g,
    /ã€å†æ¥åº—ã®ä¿ƒé€²ã€‘/g,
    /ã€.*?ã€‘/g, // ãã®ä»–ã®è¦‹å‡ºã—ã‚‚é™¤å»
];

/** 
 * Google å¯©æŸ»åŸºæº–ã«åŸºã¥ãä¸é©åˆ‡èªå¥ãƒã‚§ãƒƒã‚¯ (NGãƒ¯ãƒ¼ãƒ‰)
 * åŒ»ç™‚çš„åŠ¹æœã€å·®åˆ¥ã€æ”»æ’ƒçš„è¡¨ç¾ã€è™šå½ã®æœŸå¾…ãªã©
 */
const INAPPROPRIATE_WORDS = [
    "æ²»ã‚‹", "å¥åº·ã«ãªã‚‹", "åŠ¹ã", // åŒ»ç™‚çš„åŠ¹æœã®èª¤èª
    "çµ¶å¯¾", "å¿…ãš", // è™šå½ã®ä¿è¨¼
    "ç´å¾—ã§ããªã„", "ãŠå®¢æ§˜ã®å‹˜é•ã„", // æ”»æ’ƒçš„ãªåè«–
    "æ­»", "æ®º", "ãƒã‚«", "ã‚¢ãƒ›", // æš´åŠ›ãƒ»æš´è¨€
];

/**
 * AIå‡ºåŠ›ã‹ã‚‰ä¸è¦ãªãƒ¡ã‚¿æƒ…å ±ãƒ»ãƒã‚¤ã‚ºã‚’é™¤å»ã—ã€çµµæ–‡å­—åˆ¶é™ã‚’é©ç”¨ã™ã‚‹
 * 
 * @param text - AIç”Ÿæˆã®è¿”ä¿¡æ–‡
 * @param rating - å£ã‚³ãƒŸã®æ˜Ÿæ•°ï¼ˆçµµæ–‡å­—åˆ¶é™ç”¨ï¼‰
 * @param maxLength - æœ€å¤§æ–‡å­—æ•°ï¼ˆè¶…éæ™‚ã¯æœ«å°¾ã‚’çœç•¥ï¼‰
 * @returns æ•´å½¢å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ
 */
export function sanitizeAiOutput(text: string, rating?: number, maxLength: number = 500): string {
    let cleaned = text;

    // ä¸é©åˆ‡èªå¥ã®æ¤œçŸ¥ã¨é™¤å»ï¼ˆå®‰å…¨å¼ï¼‰
    for (const word of INAPPROPRIATE_WORDS) {
        if (cleaned.includes(word)) {
            // å˜ç´”é™¤å»ã§ã¯ãªãã€å¯©æŸ»ã«è€ãˆã†ã‚‹ã‚ˆã†å®‰å…¨ãªãƒ•ãƒ¬ãƒ¼ã‚ºã«ç½®æ›ã€ã¾ãŸã¯ãƒ­ã‚°å‡ºåŠ›
            // æœ¬æ¥ã¯å†ç”ŸæˆãŒæœ›ã¾ã—ã„ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«é™¤å»
            cleaned = cleaned.split(word).join("");
        }
    }

    // çµµæ–‡å­—åˆ¶é™ã®é©ç”¨
    if (rating !== undefined) {
        cleaned = sanitizeEmoji(cleaned, rating);
    }

    // ãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é †æ¬¡é™¤å»
    for (const pattern of NOISE_PATTERNS) {
        cleaned = cleaned.replace(pattern, "");
    }

    // å‰å¾Œã®ç©ºç™½ãƒ»æ”¹è¡Œã‚’æ•´ç†
    cleaned = cleaned.replace(/\n{3,}/g, "\n\n").trim();

    // æ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (cleaned.length > maxLength) {
        // æœ€å¾Œã®å¥ç‚¹ãƒ»èª­ç‚¹ã§åˆ‡ã‚‹
        const truncated = cleaned.substring(0, maxLength);
        const lastPeriod = Math.max(
            truncated.lastIndexOf("ã€‚"),
            truncated.lastIndexOf(".")
        );
        if (lastPeriod > maxLength * 0.5) {
            cleaned = truncated.substring(0, lastPeriod + 1);
        } else {
            cleaned = truncated + "â€¦";
        }
    }

    return cleaned;
}

// --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---

/**
 * æ˜Ÿæ•°ã«åŸºã¥ã„ã¦è¿”ä¿¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•/æ‰‹å‹•ï¼‰ã‚’åˆ¤å®šã™ã‚‹
 * 
 * @param rating - å£ã‚³ãƒŸã®æ˜Ÿæ•°ï¼ˆ1ã€œ5ï¼‰
 * @param config - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿”ä¿¡è¨­å®šï¼ˆçœç•¥æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
 * @returns "auto" ã¾ãŸã¯ "manual"
 */
export function getReplyMode(
    rating: number,
    config: ReplyConfig = DEFAULT_REPLY_CONFIG
): ReplyMode {
    const key = String(Math.min(5, Math.max(1, Math.round(rating)))) as keyof ReplyConfig;
    return config[key] ?? "manual";
}

/**
 * é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹
 * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: æ˜Ÿ2ä»¥ä¸‹ã¯æ„Ÿæƒ…ã‚’æ’ã—ãŸäº‹å®Ÿãƒ™ãƒ¼ã‚¹é€šçŸ¥ã«å›ºå®š
 * 
 * @param rating - å£ã‚³ãƒŸã®æ˜Ÿæ•°ï¼ˆ1ã€œ5ï¼‰
 * @returns é€šçŸ¥çµæœï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¿ã‚¤ãƒ—ï¼‰
 */
export function buildNotificationMessage(rating: number): NotificationResult {
    // æ˜Ÿ2ä»¥ä¸‹: ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«é€šçŸ¥ï¼ˆå®¢è¦³çš„äº‹å®Ÿã®ã¿ï¼‰
    if (rating <= 2) {
        return {
            message: `æ˜Ÿ${rating}ã¤ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã—ãŸ`,
            type: "neutral",
        };
    }

    // æ˜Ÿ3ä»¥ä¸Š: ãƒˆãƒ¼ãƒ³ã«å¿œã˜ãŸé€šçŸ¥ï¼ˆãŸã ã—ç¾æ™‚ç‚¹ã§ã¯äº‹å®Ÿãƒ™ãƒ¼ã‚¹ï¼‰
    return {
        message: `æ˜Ÿ${rating}ã¤ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã—ãŸ`,
        type: "toned",
    };
}

/**
 * ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåˆ¤å®šï¼‹é€šçŸ¥ï¼‰ã‚’çµ±åˆçš„ã«å‡¦ç†ã™ã‚‹
 * 
 * @param rating - å£ã‚³ãƒŸã®æ˜Ÿæ•°
 * @param config - è¿”ä¿¡è¨­å®š
 * @returns åˆ¤å®šçµæœ
 */
export function handleReviewAction(
    rating: number,
    config: ReplyConfig = DEFAULT_REPLY_CONFIG
): ReviewActionResult {
    return {
        mode: getReplyMode(rating, config),
        notification: buildNotificationMessage(rating),
    };
}

// --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¤å®š ---

/**
 * æ—¢å­˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
 * åŒã˜å£ã‚³ãƒŸå†…å®¹ã«å¯¾ã—ã¦å†ç”Ÿæˆã‚’é˜²ãã€APIã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã™ã‚‹
 * 
 * @param currentReviewText - ç¾åœ¨ã®å£ã‚³ãƒŸãƒ†ã‚­ã‚¹ãƒˆ
 * @param cached - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸè¿”ä¿¡ãƒ‡ãƒ¼ã‚¿ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ nullï¼‰
 * @returns ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªã‚‰ true
 */
export function isCacheValid(
    currentReviewText: string,
    cached: CachedReply | null
): boolean {
    if (!cached) return false;

    // å£ã‚³ãƒŸã®å†…å®¹ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ç¢ºèª
    if (cached.originalReviewText !== currentReviewText) return false;

    // TTLï¼ˆæœ‰åŠ¹æœŸé™ï¼‰ãƒã‚§ãƒƒã‚¯
    const generatedTime = new Date(cached.generatedAt).getTime();
    const now = Date.now();
    if (now - generatedTime > CACHE_TTL_MS) return false;

    return true;
}

// --- å‹ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
export type { ReplyConfig, ReplyMode, NotificationResult, ReviewActionResult, CachedReply };
