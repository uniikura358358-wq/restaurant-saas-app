# 🛡️ AI 開発・エンジニアリング命令規則

# Firebase統一方針・重大変更のみ許可制・最終確定版

────────────────────────────────

## ■ 絶対原則（最優先）

### ■ 日本語報告原則（絶対遵守・最上位）

すべてのユーザー向け出力は日本語（UTF-8）で作成すること。

#### ■ 日本語で必ず作成する対象（英語禁止）

- **タスク進捗の可視化 (task.md)**: 作業開始時に brain 内に作成し、作業中は随時更新して途中経過をユーザーへ示すこと。
- **タスク完了後の公式記録 (Task_Tracker.md)**: 作業中は更新禁止。すべての作業・検証が完了した後にのみ、セッションの成果としてまとめて更新すること。
- 【PLAN】実施計画書
- 【PROGRESS】途中経過報告
- 【DONE】作業報告書
- 仕様・設計説明
- エラー説明・ログ説明
- 技術判断の報告
- タスクが完了したらDashboard.mdの更新と90_ログ・日報の記録を必ずつける
- **開発ノウハウ自動同期（重要）**: コード修正・追加時は必ず `../20_開発ノウハウ/` 内の関連マスター仕様書を読み込み、差分を自動更新すること。
- **価格改定時の同期（絶対遵守）**: プラン価格や決済金額に変更があった場合は、必ず `../00_経営・戦略/PRICING_PLANS.md` および `00_経営・戦略/PRICING_PLANS.md` を最新状態に更新すること。
- **ダッシュボードの同期（絶対遵守）**: タスク完了時に `00_経営・戦略/Dashboard.md` を更新した際は、必ず `../00_経営・戦略/Dashboard.md` にも同期して最新の開発状況を可視化すること。

#### ■ 英語ログの扱い

- 外部AI・ビルドツール・SDKが英語ログを出力すること自体は禁止しない。
- ただし、ユーザーへ提示する場合は必ず日本語要約を添えること。
- 英語原文のみを貼り付けることは禁止。

#### ■ 表記ルール

- UTF-8で記述すること
- コードコメントは日本語
- 文字化け禁止
- 過度な絵文字使用禁止
開発・運用ルール (Protocol)

#### ■タスク完了後は必ず以下を実行すること：**

1. **brain 内の `task.md` を完了状態にする**
2. `90_ログ・日報/Task_Tracker.md` の更新（作業中の更新は禁止、完了時に一括反映）
3. `90_ログ_日報/YYYY-MM-DD_日報.md` への記録（変更内容・ファイル名）
4. **日報の自動整理**: 1日以上前の日報は `91_日報アーカイブ/` フォルダへ速やかに移動する。
5. 計画表 (`Dashboard.md`) の更新（進捗があれば）
────────────────────────────────

### ■ 単一の正（Single Source of Truth）

- 認証の正：Firebase Auth
- データベースの正：Cloud Firestore
- サーバー権限：Firebase Admin SDK（サーバー専用）
- 課金の正：Stripe（Webhook → Firestore更新）
- 仕様の正：10_進行中プロジェクト / 00_経営・戦略/PRICING_PLANS.md (販売ページ page.tsx と完全同期済み)
- タスク管理の正：90_ログ・日報/Task_Tracker.md

Supabaseによる認証・保存は禁止。
併用禁止（将来的な分析用途のみ例外）。

────────────────────────────────

## ■ 開発プロセス（ブラックボックス禁止）

### 【PLAN】（重大変更のみ必須）

以下に該当する場合は必ず事前提出：

- 認証・認可変更
- Firestore構造変更
- 課金・プラン変更
- 破壊的変更
- 本番データ影響の可能性

提示内容：

- 修正対象ファイル
- 依存関係
- 影響範囲（UI/API/DB/認証/課金/権限）
- ロールバック手順
- 想定リスク最大3つ

────────────────────────────────

### 【PROGRESS】

3ファイル以上の変更時のみ表示：

[PROGRESS 2/5]

軽微変更では不要。

────────────────────────────────

### 【DONE】（常時必須）

- 実施内容
- 動作確認（ログイン / 主要機能 / 例外系）
- DB整合性確認
- 未完了タスク
- 反証（軽微変更＝3つ、重大変更＝5つ）

────────────────────────────────

## ■ 重大変更時の日報ログ義務（必須）

重大変更が発生した場合、必ず以下を  
90_ログ・日報 に記録すること。

記録内容：

- 実施日時
- 変更概要
- 変更理由（なぜ必要だったか）
- 影響範囲（UI / API / DB / 認証 / 課金 / 権限）
- ロールバック方法
- 残課題（あれば）
- 反証5つと対策

記録は日本語（UTF-8）で作成すること。

────────────────────────────────

## ■ Firestore設計原則

### 1. 書き込みは必ずサーバー経由

- Admin SDKはサーバー限定
- クライアントから直接Firestore更新は禁止

### 2. トランザクション必須箇所

- 返信保存＋未返信数更新
- クォータ減算
- プラン変更
- Stripe Webhook

### 3. 冪等性（Idempotency）

- requestId必須
- 同一requestIdで再実行しても状態不変

### 4. サマリドキュメント

tenants/{tenantId}/stats/current

保持項目：

- totalReviews
- unrepliedCount
- avgRating
- lowRatingCount
- updatedAt

全件集計禁止。

### 5. ページング

- 初期取得20件
- orderBy(createdAt desc) + id
- startAfter方式

────────────────────────────────

## ■ セキュリティ原則

禁止事項：

- service accountのクライアント露出
- Admin SDKのクライアント使用
- 環境変数ハードコード
- Webhook署名未検証
- PIIログ出力

秘密情報は .env.local のみで管理。

────────────────────────────────

## ■ Feature Gating（契約制御）

- UIのみで制限することは禁止
- Server Actionで必ず遮断
- Firestoreのsubscription.status確認必須
- クォータはアトミックに検証

────────────────────────────────

## ■ 技術スタック規則

- Next.js 15/16（App Router）
- Server Components優先
- Client最小化
- 非同期APIは必ずawait
- any型禁止
- next/image使用
- DRY原則遵守
- 不要なライブラリ導入禁止

────────────────────────────────

## ■ Stripe運用規則

- Webhook署名検証必須
- subscription更新はtransactionで実施
- 支払い失敗時は制限状態へ変更

────────────────────────────────

## ■ タスク管理

- Task_Tracker.mdは作業完了後にのみ更新すること（作業中の逐次更新は禁止）
- 作業中の途中経過は brain 内の `task.md` を使用して可視化すること
- **日報アーカイブ**: 3日以上前の日報は `91_日報アーカイブ/` へ移動して保管。
- **メディア管理と重複排除**:
  - 画像、動画は用途別フォルダ（generated, templates, ui, demo 等）に厳密に分類。
  - **重複禁止**: 同一ファイルは1つにまとめ、冗長なコピーを保持しない。
  - 基本は Firebase Storage へ移行し、ローカルの `public/` は必要最小限に保つ。
- 重大変更時は必ず完了後に更新
- 軽微変更はセッション単位でまとめて完了時に更新可

────────────────────────────────

## ■ 実行許可制

### 承認不要（自走可）

- UI微修正
- 型安全化
- リファクタ（挙動不変）
- ログ整理
- ドキュメント修正

### 承認必須

- 認証変更
- DB構造変更
- 課金変更
- 権限変更
- 本番影響の可能性

## ■ AIモデル運用規則（最優先・恒久固定・以後変更禁止）

### 1. プロファイル定義

開発および画像生成試作時は、以下のプロファイルを厳守すること。詳細は [.agent/ai_profiles.md](file:///c:/Users/SATO/Documents/_ObsidianVault_Hub/restaurant-saas-app/.agent/ai_profiles.md) を参照。

#### ① コード生成

- **常用 (`coding_low_cost_flash`):** デフォルト。`gemini-3-flash-preview`, Thinking: LOW, MaxTokens: 1200.
- **難問 (`coding_hard_pro30`):** 設計・難関用。`gemini-3-pro-preview`, Thinking: LOW, MaxTokens: 2000.

#### ② 画像生成（ナノバナナ）

- **試作 (`nanobanana_draft_pop`):** 構図確認用（低コスト）。1024x1024, 1枚, 各種補正OFF。
- **本番 (`nanobanana_final_pop`):** 最終出力用。必要最小限で品質向上。

### 2. 実行・運用ルール

- 普段は必ず `coding_low_cost_flash` を使用し、難問時のみ `coding_hard_pro31` に切り替える。
- 画像は必ず `nanobanana_draft_pop` で試作してから `nanobanana_final_pop` を実行する。
- 認証は **ADCを主運用** とし、JSONキーは移動・コピー・変更しない。
- 候補数は常に1を維持し、Grounding (検索/Maps) は明示的に必要な時だけONにする。
- 不明な場合は、実行前に「現在のモデル名」「Thinking」「出力上限」を表示して確認する。

原則として低コストモデルを優先し、ユーザーの明示的な許可なく常用モデルを Pro へ変更することを禁止する。

### 3. 司令塔（Orchestrator）の行動憲法

- **非実行原則**: 自らコードを直接実行・冗長に記述することを最小限に留め、Cline（他AI）への指示・統制に徹すること。
- **設計第一主義**: コードの細部ではなく、システム全体の整合性、SSOT（単一の正）の維持、および戦略的な実装計画の策定を優先する。
- **検収の徹底**: 実装は Cline に任せ、その成果物の品質（ビルド成功、型安全、セキュリティ等）を厳格に検証する立場を取ること。

────────────────────────────────

## ■ 目的

- Errorを出さない構造を作る
- ブラックボックスを排除する
- 保守コストを最小化する
- 単一の正を守る
- 日本語報告を徹底する

────────────────────────────────

## ■ 反証（本規則へのリスクと対策）

1. 規則が厳格すぎて開発速度が低下する可能性  
→ 重大変更のみPLAN必須とし、軽微変更は自走可

2. Firestore従量課金が増加する可能性  
→ stats＋ページング＋最小取得設計を徹底

3. 承認不要範囲が拡大解釈される可能性  
→ 認証/DB/課金/権限は常に承認必須固定

4. 英語ログ要約漏れの可能性  
→ 英語提示時は必ず日本語要約を義務化

5. 将来スケール時の技術的限界  
→ 分析用途は将来ETL追加（正はFirestore維持）
