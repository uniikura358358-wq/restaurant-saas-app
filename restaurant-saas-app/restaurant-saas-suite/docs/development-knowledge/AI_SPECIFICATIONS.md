# AIモデル最新仕様書 (2026年2月更新)

本プロジェクトで使用する Vertex AI (Gemini) のモデル ID と運用ルールの定義です。

## 1. 司令塔（Orchestrator）の役割と自己制限事項

本システムにおける Antigravity は、自らコードを記述・実行する「作業員」ではなく、戦略・設計・指示を司る「司令塔」として振る舞うこと。

- **コード実装の外部委託**: 実際的なコードの記述、ファイル編集、コマンド実行は、原則として Cline（他 AI エージェント）へ委託する。
- **思考の主軸**: 実装の「方法」ではなく、ビジネスロジック・アーキテクチャ・リスクの「設計」に集中する。
- **アウトプットの定義**: 具体的かつ実行可能な `implementation_plan.md` および、Cline がそのまま利用できる「実装指令書」を主成果物とする。
- **検収責任**: Cline のアウトプットが仕様およびセキュリティ原則を満たしているか、ビルドログや検証スクリプトを用いて厳格に検収する責任を負う。

---

## 2. 推奨モデル一覧

| モデル表示名 | Vertex AI モデル ID | 特徴 |
| :--- | :--- | :--- |
| **Gemini 3 Flash (Preview)** | `gemini-3-flash-preview` | 2026年最新。超高速推論。Thinking Level 対応。 |
| **Gemini 2.5 Flash** | `gemini-2.5-flash` | 低遅延・高知能のバランス型。低コスト。 |
| **Gemini 2.5 Flash Image** | `gemini-2.5-flash-image` | 画像生成専用。全プラン共通。 |

---

## 3. プラン別モデルポリシー（2026-02-20 確定）

### 🟦 STANDARD プラン

| 項目 | 設定 |
| :--- | :--- |
| メインモデル | `gemini-2.5-flash` |
| サブモデル | `gemini-3-flash-preview` (LOW) |
| 画像生成 | `gemini-2.5-flash-image` |

**切替条件（サブモデルを使う特殊ケース）:**

- 口コミが★1〜2
- ネガティブワードを含むレビュー
- 感情理解が必要な長文クレーム

---

### 🟪 Pro プラン

| 項目 | 設定 |
| :--- | :--- |
| メインモデル | `gemini-3-flash-preview` (LOW) |
| サブモデル | `gemini-2.5-flash` |
| 画像生成 | `gemini-2.5-flash-image` |

**切替条件（サブに落とすケース）:**

- 高速レスポンスが必要な短文タスク（自動判断）

---

### 🟧 Pro Premium プラン

| 項目 | 設定 |
| :--- | :--- |
| メインモデル | `gemini-3-flash-preview` (LOW)（常時） |
| サブモデル | `gemini-2.5-flash`（速度必要時のみ） |
| 画像生成 | `gemini-2.5-flash-image` |

**特記:**

- 全テキスト生成は基本すべて 3 Flash LOW
- 多言語返信（英語/中国語）も 3 Flash LOW で処理

---

## 4. 機能別パラメータ定義（全プラン共通値）

### ① Google口コミ 自動返信

| パラメータ | 値 |
| :--- | :--- |
| temperature | 0.3 |
| top_p | 0.85 |
| top_k | 30 |
| max_output_tokens | 220 |

**出力ポリシー:**

- 日本語・敬語・絵文字可（emoji_level 設定に従う）
- 200〜250文字以内
- 感謝 → お詫び → 改善 → 来店誘導 の構成
- 個人名NG / 店舗名OK

**プラン別モデル切替:**

| プラン | ★3〜5 | ★1〜2 |
| :--- | :--- | :--- |
| STANDARD | 2.5 Flash | **3 Flash LOW** |
| Pro | 3 Flash LOW | 3 Flash LOW |
| Pro Premium | 3 Flash LOW | 3 Flash LOW |

**絵文字ルール（全プラン共通）:**

- ★3〜5：emoji_level 設定どおり（なし/控えめ/普通/多め）
- ★1〜2：最大2個まで（謝罪系絵文字のみ）

---

### ② Instagram 半自動投稿（マニュアル投稿方式）

**基本方針:**

- Metaの審査およびビジネス認証を回避するため、公式APIによる自動投稿は一切行わない。
- システムは「投稿用素材（画像・キャプション）」を生成するまでを担当する。
- 最終的な投稿アクションは、ユーザーが手動で保存・コピーして Instagram アプリで行う。

**キャプション/タグ生成:**

| パラメータ | 値 |
| :--- | :--- |
| temperature | 0.7 |
| top_p | 0.9 |
| top_k | 40 |
| max_output_tokens | 350 |

**画像生成:**

- モデル：`gemini-2.5-flash-image`
- サイズ：1024×1024（1:1）/ 4:5（縦）選択可
- 1リクエスト1枚（ユーザー明示指示時は複数可）
- テキスト入れ最小限（外部ツール推奨）

---

### ③ AI領収書処理（事務作業）

| パラメータ | 値 |
| :--- | :--- |
| temperature | 0.1 |
| top_p | 0.7 |
| top_k | 20 |
| max_output_tokens | 256 |

**出力ポリシー:**

- 出力は必ず JSON
- 不明項目は `null` / `"unknown"`
- エラー時：`{ "error_message": "...", "raw_input": "..." }`

**使用モデル:** プランのメインモデルに従う

| プラン | 使用モデル |
| :--- | :--- |
| STANDARD | `gemini-2.5-flash` |
| Pro | `gemini-3-flash-preview` (LOW) |
| Pro Premium | `gemini-3-flash-preview` (LOW) |

---

### ④ POP / メニュー AI 自動生成

**キャッチコピー・レイアウト生成:**

| パラメータ | 値 |
| :--- | :--- |
| temperature | 0.7 |
| top_p | 0.9 |
| top_k | 40 |
| max_output_tokens | 1024 (JSON含むため拡張) |

**Premium Design Atoms (エンジニア・デザイナー向け仕様):**

| フィールド | 役割 | 推奨設定 |
| :--- | :--- | :--- |
| `shadow` | 視認性と高級感 | `2px 2px 8px rgba(0,0,0,0.4)` 等 |
| `stroke` | 文字の縁取り | 背景と同系色の際に `1px #fff` 等で縁取り |
| `glass` | 磨りガラス背景 | 写真が複雑な場合に `true` に設定しパネルを敷く |
| `decorations` | 装飾要素 | `ribbon` (おすすめ), `seal` (価格強調), `brush` (和風演出) |

**出力ポリシー:**

- 単なる配置ではなく「空間の演出」を意識すること。
- ターゲット層（高級、カジュアル、伝統的）に合わせたフォントとエフェクトの組み合わせを選択。
- **AI ライブ・エディット (Execution Engine):** チャットを通じて JSON 命令（`PopState` 形式）を発行し、キャンバスの状態を直接更新する。
- **物理パーツ生成:** `shapes`（直線、四角、円）を適切な座標 (`x`, `y`, `width`, `height`) で配置し、装飾として活用する。
- **要素のリセット:** ユーザーの指示（「戻して」「リセット」等）に応答し、特定要素のスタイルを初期化する。
- **Canvaテンプレート固定レイアウト:** `PRO_LAYOUT_CONFIG` に定義されたテンプレートは、AI レイアウトよりも優先して座標が適用される。

**プラン別デザイン目標:**

| プラン | 目標品質 | AI戦略 |
| :--- | :--- | :--- |
| **STANDARD** | プロ品質 (Professional) | 清潔感、視認性を重視。基本に忠実で整ったプロの仕上がり。 |
| **PRO / PREMIUM** | 感動レベル (WOW) | 想像を超える演出。大胆なレイアウト、幾重にも重なる装飾、完璧な陰影、Glassmorphismをフル活用。 |

**画像生成:**

- モデル：`gemini-2.5-flash-image`
- サイズ：1024×1024
- テキスト入れ少なめ

---

### ⑤ AIチャットボット（相談窓口）

| パラメータ | 値 |
| :--- | :--- |
| temperature | 0.4 |
| top_p | 0.85 |
| top_k | 30 |
| max_output_tokens | 512 |

**出力ポリシー:**

- 箇条書き中心・絵文字使用可・1応答1テーマ
- 使用モデル：各プランのメインモデル

---

## 5. コンテキスト管理（全プラン共通）

- 直近3〜4ターン＋要約1件のみ保持
- 長い履歴は破棄し、新規セッションに切替
- 大量画像読込後は必ずセッション終了
- **Thinking Budget: 常に LOW**
- 無駄な長文生成は禁止

---

## 6. 開発用プロファイル定義と運用ルール（最優先）

開発および画像生成試作時は、以下のプロファイルを厳守すること。詳細は [.agent/ai_profiles.md](file:///c:/Users/SATO/Documents/_ObsidianVault_Hub/restaurant-saas-app/.agent/ai_profiles.md) を参照。

### ① コード生成プロファイル

- **常用 (`coding_low_cost_flash`):** デフォルト。`gemini-3-flash-preview`, Thinking: MINIMAL, MaxTokens: 1200.
- **難問 (`coding_hard_pro31`):** 設計・難関用。`gemini-3.1-pro-preview`, Thinking: LOW, MaxTokens: 2000.

### ② 画像生成プロファイル

- **試作 (`nanobanana_draft_pop`):** 構図確認用（低コスト）。1024x1024, 1枚, 各種補正OFF。
- **本番 (`nanobanana_final_pop`):** 最終出力用。必要最小限で品質向上（アップスケール、高品質補正等）。

### 運用ルール

- 普段は必ず `coding_low_cost_flash` を使用する。
- 画像は必ず `nanobanana_draft_pop` で試作してから `nanobanana_final_pop` を実行する。
- Grounding (検索/Maps) は明示的に必要な時だけONにする。

## 7. 禁止事項

- 個人情報の書き込み
- 無駄に長い文章（出力上限を超えないよう管理）
- モデル・Thinking Level の勝手な切替（開発用プロファイルを優先）
- 画像生成のバッチ実行（ユーザー明示指示時は複数可）
- 技術的内部情報の露出
- Grounding の常時ON（コスト回避）

## 8. 実装メモ（エンジニア向け）

```typescript
// プラン別ポリシー取得
const { getPlanAiPolicy } = await import("@/lib/vertex-ai");
const planPolicy = getPlanAiPolicy(planName);
// planPolicy.primary / secondary / primaryNeedsThinking / secondaryNeedsThinking

// Gemini 3系は global エンドポイント必須
// Gemini 2.5系は us-central1 エンドポイント
```

- `gemini-3-flash-preview` → **global** エンドポイント
- `gemini-2.5-flash` → `us-central1` エンドポイント
- Gemini 3系には必ず `thinking_config: { thinking_level: 'LOW', include_thoughts: false }` を付与

---

## ■ タスク管理運用フロー (2026-02-21 改訂)

開発中のブラックボックス化を避け、かつプロジェクトの履歴を正確に維持するため、以下の二段階管理を徹底する。

### 1. 作業中の進捗管理 (`task.md`)

- **場所**: AI内部作業領域 (`brain/<id>/task.md`)
- **役割**: 作業ステップの分解と、リアルタイムな進捗（途中経過）の可視化。
- **義務**: セッション開始時に作成し、作業中は随時（3〜5ツール実行ごと）更新。ユーザーはこれを見て「現在何をしているか」を把握する。

### 2. 完了後の公式記録 (`Task_Tracker.md`)

- **場所**: プロジェクト内 (`90_ログ・日報/Task_Tracker.md`)
- **役割**: 永続的な成果記録。
- **制限**: **作業中の小まめな更新（逐次更新）は禁止。**
- **義務**: 全てのコード修正・検証・ビルド確認が完了した後、そのセッションの集約された成果としてのみ一括更新する。

### 3. ログのアーカイブ運用 (2026-02-21 追加)

- **義務**: 作成から3日以上経過した日報（`YYYY-MM-DD_日報.md`）は、作業効率化のため `91_日報アーカイブ/` フォルダへ速やかに移動する。
- **1日1ファイルの徹底**: 日報は1日につき1ファイル（`YYYY-MM-DD_日報.md`）を厳守する。同じ日に複数のセッションが発生した場合は、新規ファイルを作成せず、既存ファイルにセクションを追記して一元管理すること。
- **外部フォルダ保管**: 昨日以前の既録ログは、親ディレクトリの `90_ログ・日報/` へ移動し、開発ディレクトリの検索ノイズを最小化する。

### 4. メディア管理と重複排除 (2026-02-21 追加)

- **フォルダ分類**: 画像・動画は `public/images/generated`, `templates`, `ui`, `public/videos/assets` 等の用途別フォルダに厳密に分類する。
- **重複禁止**: 同一ファイルは1つにまとめ、冗長なコピーを保持しない。複数の場所から参照する場合は1つのファイルを共有する。
- **移行**: 可能な限り Firebase Storage を活用し、ローカル資産の軽量化を図る。
