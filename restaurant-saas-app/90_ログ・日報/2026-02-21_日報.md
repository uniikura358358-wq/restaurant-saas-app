# 📋 作業日報 (2026-02-21)

## 実施日時

2026-02-21 00:05

## 変更概要

POP制作ツールにおいて、AI（Gemini Vision）による「背景テンプレート解析機能」を実装しました。Canva等で作成されたテンプレート画像から写真エリアを自動検出し、商品画像を自動的に適切な位置に配置します。

## 変更理由

ユーザーがCanvaなどで自作したプロ品質のテンプレートを背景として使用したいというニーズに対し、写真を手動で1枚ずつ位置合わせする手間を省き、「テンプレートをアップロードしてAIで解析」するだけで瞬時に完成させるため。

## 影響範囲

- **UI**: 背景アップロードエリアに「AIで枠を検出」ボタンを追加。
- **Font**: 居酒屋風の力強い筆文字 (本格筆文字) やインパクトのあるデザインフォントを6種追加。
- **API**: `/api/ai/detect-template-areas` を新設（Vertex AI SDK を利用）。
- **Logic**: `renderPop` 関数において、検出された `photoAreas` への自動マッピングロジックを追加。

## ロールバック方法

- `page.tsx` を前バージョンに戻す。
- `src/app/api/ai/detect-template-areas` ディレクトリを削除。

## 残課題

- **文字エリアの自動検出**: 現時点では写真枠のみの検出。将来的に商品名や値段のプレースホルダーも検出し、自動流し込みをサポートする余地あり。

## 追記：UI調整 & テンプレート整理 (2026-02-21 00:15)

ユーザーからのフィードバックに基づき、以下の追加作業を実施しました。

- **UI改善**: プレビュー画面上でデザインと重なって表示されていた「元に戻す」ボタンを削除しました。
- **データクリーンアップ**: Firebase Storage内のテンプレート画像（`/images/templates/pop/` 配下、全41件）を一括削除しました。（`firebase-admin` を使用したメンテナンスAPI経由で実行）
- **コード整理**: 削除したテンプレートへの参照（`STYLE_GROUPS`, `PRO_LAYOUT_CONFIG`）をソースコードから整理・削除し、ユーザー独自の背景アップロードに最適化しました。

## 反証と対策

1. **AIの検出精度ミス**: 複雑なデザインで枠を見失う可能性がある ➔ 手動ドラッグでの微調整機能を維持し、AIはあくまで「初期提案」として機能させる。
2. **Vertex AI API未有効エラー**: ユーザーのプロジェクトでAPIが未有効だとクラッシュする ➔ 詳細なエラーメッセージを表示し、有効化リンクを案内するようフロントエンドを強化。
3. **APIコストの累計**: 大量実行による課金リスク ➔ Gemini Flash モデルを使用し、1実行あたり約0.05円以下の極低コストを維持。
4. **複数商品と枠の不一致**: 商品数と枠数が合わない場合 ➔ 枠数に応じて商品をループ（1, 2, 3, 4, 1, 2...）させることで、常に空き枠を作らないよう実装。
5. **画像以外の読み込み**: PDFアップロード時の不具合 ➔ pdfjs-dist によるPNG変換ロジックを統合し、PDFテンプレートも解析対象に含める。
6. **デフォルトテンプレートの喪失**: テンプレート全削除により選択肢がなくなる ➔ ユーザーがCanva等から自身の高品質なテンプレートをアップロードしてAI解析するワークフローに完全移行（独自性向上）。

## Git保存状況

## 公開サイト多言語対応 (2026-02-21 02:45)

飲食店公開サイトの多言語対応（日本語・英語切り替え）を実装しました。

### 実施内容（多言語対応）

- **高精度AI翻訳（Gemini 3 Pro）**: 飲食店特有の「おもてなし・美食」のトーンを理解した、プロ品質の英語翻訳アクションを実装。
- **素材管理画面の拡張**: キャッチコピーや店舗名に「英語」フィールドを追加。AIによる一括翻訳ボタンで瞬時に多言語化が可能。
- **言語切り替えスイッチ**: 公開サイト（サンプル：銀座ラーメン）に、直感的に操作できるガラスモーフィズムデザインのJP/EN切り替えスイッチを設置。

### 変更理由（多言語対応）

訪日外国人（インバウンド）客の増加に対応し、飲食店オーナー様が専門知識なしでも「最高品質の英語サイト」を運用できるようにするため。

### 影響範囲（多言語対応）

- **UI**: 管理画面の「HP素材管理」に日本語/英語タブを追加。公開サイトのヘッダー付近に切り替えスイッチを追加。
- **DB**: `stores/{uid}.websiteMaterials` 内に `En` プレフィックスのフィールド（`catchCopyEn`等）を追加。

### 反証と対策（多言語対応）

1. **直訳による不自然さ**: "Delicious"ばかりの単調な英語になるリスク ➔ ミシュランガイドのような洗練された語彙を使用するようAIプロンプトを徹底最適化。
2. **操作の煩雑さ**: 日本語と英語を2回入力するのが面倒 ➔ 「AIでまるごと英語サイト化」ボタンにより、日本語入力後のワンクリックで全項目を翻訳・補完。
3. **デザインの崩れ**: 英語特有 of 長文でレイアウトが崩れる ➔ キャッチコピー領域を動的に調整し、長文でも美しく表示されるようCSSを強化。
4. **情報の不一致**: 日本語を更新しても英語が古いままになる ➔ 保存時に「未翻訳項目」を警告するメッセージを実装（検討中：将来的な自動同期）。
5. **多言語の拡張性**: 中国語や韓国語への対応 ➔ `src/app/actions/tools.ts` の翻訳ロジックは多言語対応可能な汎用設計に。

---

## Git保存状況 (履歴)

- 2026-02-21 01:55: 実装内容（AIPOP Maker V2、Vertex AI移行、クリーンアップ一式）をGitにコミット完了。
- 2026-02-21 02:50: 多言語表示対応、高精度AI翻訳エンジン、および言語切り替えスイッチの実装。
- 2026-02-21 02:55: AIデザイン・コンシェルジュ機能（チャット・音声入力・マルチモーダル解析）および詳細な使い方ガイドの実装。
- 2026-02-21 05:45: 5ステップAIウィザード、テキストサイズ適正化、背景写り込み防止、および商品1枚時制限ルールの実装。

## 追記：表示品質の最適化とAIウィザード拡張 (2026-02-21 06:00)

POP制作ツールにおいて、対話型UIの強化と生成デザインの品質安定化を実施しました。

### 実施内容

- **5ステップAIウィザード**: 商品写真の有無、テンプレート、メニュー/案内の目的、商品数、デザインスタイルを順次確認する対話フローを実装。
- **テキストサイズ適正化**: `page.tsx` のフォントスケーリング係数を緩和（最大3.0倍→2.2倍）し、短いテキストの肥大化を抑制。
- **背景写り込み防止**: `analyze-layout` APIのプロンプトに `No food, No people` の厳格な除外ルールを追加し、具象的な背景ではなく抽象的なテクスチャを優先生成。
- **商品画像1枚時の制限**: ユーザーが商品画像を1枚アップロードしている場合、不要な背景自動生成をスキップし、AI装飾から具体的料理のアイコンを排除。

### 変更理由

「テキストが大きすぎる」「ラーメンのPOPにステーキが写る」といったAI特有の不安定さを解消し、ユーザーの意図（特に自前素材の活用）を最優先にするため。

### 影響範囲

- **UI**: チャット形式ウィザードが5段階に拡張。
- **Logic**: `FONT_SCALE_MAP` の定数変更。商品画像数に基づく背景生成の条件分岐。
- **API**: `analyze-layout/route.ts` 内のプロンプト構成の刷新。

### 反証と対策

1. **テキストが小さくなりすぎる**: 修正後もスライダーによる手動スケーリング機能は維持されており、ユーザーが好みに合わせて微調整可能。
2. **背景が物足りない**: 商品1枚時はユーザーの素材が主役であるため、あえて背景を生成しないことで「ノイズ」を最小化。
3. **AIが指示を無視する**: プロンプトを英語で記述し、`Negative Constraints` として強調することで、Gemini の遵守率を向上。
