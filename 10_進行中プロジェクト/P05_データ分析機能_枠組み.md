# P05_データ分析機能_枠組み.md

## 1. 概要 (将来構想)

Firestore に蓄積された口コミ傾向やAI返信の効果、Stripe の収益データを統合的に可視化し、経営改善案をAIが提示するレポート機能。

## 2. 集計定義

- **Sentiment Analysis**: 口コミの感情分析（Gemini を使用しポジティブ/ネガティブ比率を算出）。
- **Conversion Tracking**: HP/チャットボット経由の予約成立数。
- **Churn Risk**: Stripe Webhook から支払失敗やキャンセルを検知し、離脱リスクを警告。

## 3. DB構造案 (Firestore)

- **`users/{uid}/stats/current`** (DashboardStats):
  - `totalReviews`: number
  - `unrepliedCount`: number
  - `averageRating`: number
- **`analytic_reports/{uid}`**:
  - `monthlyInsights`: string (AIによる日本語アドバイス)
  - `kpiData`: Map (revenue, engagement_rate)

## 4. 依存項目

- `STRIPE_WEBHOOK_SECRET`: 収益データ同期用。
- **データ永続性**: 大規模化時は BigQuery 連携（Firebase Extension経由）。

## Next Step

Firestore の `totalReviews`, `averageRating` を、書き込み時にアトミックに加算する `DashboardStats` 更新トリガーの完全実装。
