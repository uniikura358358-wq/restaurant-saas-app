# 🧠 AIモデル運用・実装標準 (Master Specification)

## 1. モデル選択基準

本プロジェクトでは、性能とコスト、レスポンス速度のバランスを最適化するため、以下のモデル優先順位を厳守する。

| 完了優先度 | モデル名 | 用途 | 内部月間予算・回数 (非公開) |
| :--- | :--- | :--- | :--- |
| **1 (メイン)** | `gemini-3-flash-preview` | 全ての基本生成タスク | L: 700円/2,000回, S: 1500円/4,000回, P: 2000円/5,500回 |
| **2 (サブ)** | `gemini-2.5-flash` | フォールバック・予備 | 同上 |

## 2. 実装ルール

### A. 自動リトライ/フォールバックの実装

Server Actions または API Routes でAI生成を行う際は、必ず `targetModels` 配列を定義し、ループによるフォールバックを実装すること。

```typescript
const targetModels = ['gemini-3-flash-preview', 'gemini-2.5-flash'];
for (const modelName of targetModels) {
  try {
    // AI生成ロジック
    break; // 成功したら抜ける
  } catch (error) {
    // ログを記録し、次のモデルへ
  }
}
```

### B. タイムアウト設定

- `gemini-3-flash-preview`: 推論時間を考慮し、やや長めのタイムアウト（例: 30秒）を許容する可能性があるが、標準は10秒〜とする。
- モデル特性に応じた適切なエラーハンドリングを行うこと。

### C. クォータの物理分離 (Safety Isolation)

高コストな画像生成と、低コストなテキスト生成はシステムレベルで物理的に分離管理する。

1. **画像生成 (Image Quota)**:
   - 制限方式: **厳格な回数制限 (30 / 60 / 90回)**
   - 特徴: 1回あたりのコストが高いため、予算(円)に関わらず回数で即座に遮断する。
2. **テキスト生成 (Text Quota)**:
   - 制限方式: **予算(円) と 回数(回) の二重制限**
   - 特徴: どちらか先に上限に達した方で遮断する。単価高騰時は予算で守り、スパム時は回数で守る。

この分離構造により、テキスト枠を悪用して高コストな画像を大量生成されるリスクを構造的に排除する。

## 3. 更新履歴

- 2026-02-17: 運用ルールの明文化。メインを `gemini-3-flash-preview`、サブを `gemini-2.5-flash` に固定。
